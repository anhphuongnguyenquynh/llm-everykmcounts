json_test = [{'resource_state': 2, 'athlete': {'id': 46133187, 'resource_state': 1}, 'name': 'Morning Run', 'distance': 2322.8, 'moving_time': 1397, 'elapsed_time': 1809, 'total_elevation_gain': 0.0, 'type': 'Run', 'sport_type': 'Run', 'workout_type': None, 'id': 13383411663, 'start_date': '2025-01-18T00:17:00Z', 'start_date_local': '2025-01-18T07:17:00Z', 'timezone': '(GMT+07:00) Asia/Ho_Chi_Minh', 'utc_offset': 25200.0, 'location_city': None, 'location_state': None, 'location_country': None, 'achievement_count': 0, 'kudos_count': 3, 'comment_count': 0, 'athlete_count': 2, 'photo_count': 0, 'map': {'id': 'a13383411663', 'summary_polyline': '}dv`Auo~iSj@e@BG?OGSQ_AGm@MUKEs@L[NAAW?u@FQNSBk@V]HUXe@JUNIRGdA?x@B^Jb@NL\\C^GbB[d@ObAg@JKH?JGlAs@VUBUc@cB?WEQCIMCq@Lg@@GBM@ICO@MHQF{@X[Fq@Zo@LOVK\\BhBBb@Hl@LLb@Ct@O', 'resource_state': 2}, 'trainer': False, 'commute': False, 'manual': False, 'private': False, 'visibility': 'everyone', 'flagged': False, 'gear_id': None, 'start_latlng': [10.770125, 106.656695], 'end_latlng': [10.768338, 106.658095], 'average_speed': 1.663, 'max_speed': 2.811, 'average_cadence': 70.0, 'has_heartrate': True, 'average_heartrate': 117.6, 'max_heartrate': 161.0, 'heartrate_opt_out': False, 'display_hide_heartrate_option': True, 'elev_high': 7.4, 'elev_low': 6.3, 'upload_id': 14274573405, 'upload_id_str': '14274573405', 'external_id': 'garmin_ping_403249883970', 'from_accepted_tag': False, 'pr_count': 0, 'total_photo_count': 0, 'has_kudoed': False}, {'resource_state': 2, 'athlete': {'id': 46133187, 'resource_state': 1}, 'name': 'Ch∆∞ ƒêƒÉng Ya', 'distance': 1229.5, 'moving_time': 2893, 'elapsed_time': 5827, 'total_elevation_gain': 60.9, 'type': 'Run', 'sport_type': 'TrailRun', 'workout_type': 0, 'id': 13221085819, 'start_date': '2024-12-30T04:37:54Z', 'start_date_local': '2024-12-30T11:37:54Z', 'timezone': '(GMT+07:00) Asia/Ho_Chi_Minh', 'utc_offset': 25200.0, 'location_city': None, 'location_state': None, 'location_country': None, 'achievement_count': 0, 'kudos_count': 3, 'comment_count': 0, 'athlete_count': 1, 'photo_count': 0, 'map': {'id': 'a13221085819', 'summary_polyline': 'yxfuA}|nrSSe@I[@EEQE_@DSQOIEI?@B^NLC?CJJRIVEHGRCHE\\A@Bf@@JBJ\\DA@@?LD??@NBYCFCA@AAlAXe@GWKC@MCISOSOEu@GM@OFQ@_@HK@KAIBAD?NDf@Jl@d@bALRLp@Et@KZ?FEDIVAH@JXJVFh@?JJAz@@JJRNHl@Jh@NLL@J', 'resource_state': 2}, 'trainer': False, 'commute': False, 'manual': False, 'private': False, 'visibility': 'everyone', 'flagged': False, 'gear_id': None, 'start_latlng': [14.130105, 108.051197], 'end_latlng': [14.128996, 108.049062], 'average_speed': 0.425, 'max_speed': 1.633, 'average_cadence': 54.8, 'has_heartrate': True, 'average_heartrate': 106.7, 'max_heartrate': 130.0, 'heartrate_opt_out': False, 'display_hide_heartrate_option': True, 'elev_high': 975.1, 'elev_low': 876.1, 'upload_id': 14099931169, 'upload_id_str': '14099931169', 'external_id': 'garmin_ping_397788373446', 'from_accepted_tag': False, 'pr_count': 0, 'total_photo_count': 3, 'has_kudoed': False}, {'resource_state': 2, 'athlete': {'id': 46133187, 'resource_state': 1}, 'name': 'Evening Run', 'distance': 2256.4, 'moving_time': 1339, 'elapsed_time': 1350, 'total_elevation_gain': 3.2, 'type': 'Run', 'sport_type': 'Run', 'workout_type': None, 'id': 13174154227, 'start_date': '2024-12-23T12:19:59Z', 'start_date_local': '2024-12-23T19:19:59Z', 'timezone': '(GMT+07:00) Asia/Ho_Chi_Minh', 'utc_offset': 25200.0, 'location_city': None, 'location_state': None, 'location_country': None, 'achievement_count': 0, 'kudos_count': 1, 'comment_count': 0, 'athlete_count': 1, 'photo_count': 0, 'map': {'id': 'a13174154227', 'summary_polyline': '', 'resource_state': 2}, 'trainer': False, 'commute': False, 'manual': False, 'private': False, 'visibility': 'everyone', 'flagged': False, 'gear_id': None, 'start_latlng': [], 'end_latlng': [], 'average_speed': 1.685, 'max_speed': 3.0, 'average_cadence': 79.3, 'has_heartrate': True, 'average_heartrate': 147.7, 'max_heartrate': 173.0, 'heartrate_opt_out': False, 'display_hide_heartrate_option': True, 'elev_high': 8.4, 'elev_low': 3.8, 'upload_id': 14049383951, 'upload_id_str': '14049383951', 'external_id': 'garmin_ping_395953702645', 'from_accepted_tag': False, 'pr_count': 0, 'total_photo_count': 0, 'has_kudoed': False}, {'resource_state': 2, 'athlete': {'id': 46133187, 'resource_state': 1}, 'name': 'Ho√†ng h√¥n ƒê√† L·∫°t üå§Ô∏èüå§Ô∏èüå§Ô∏è', 'distance': 5047.3, 'moving_time': 2723, 'elapsed_time': 2888, 'total_elevation_gain': 2.3, 'type': 'Run', 'sport_type': 'Run', 'workout_type': 3, 'id': 13154050173, 'start_date': '2024-12-20T10:02:35Z', 'start_date_local': '2024-12-20T17:02:35Z', 'timezone': '(GMT+07:00) Asia/Ho_Chi_Minh', 'utc_offset': 25200.0, 'location_city': None, 'location_state': None, 'location_country': None, 'achievement_count': 1, 'kudos_count': 3, 'comment_count': 0, 'athlete_count': 1, 'photo_count': 0, 'map': {'id': 'a13154050173', 'summary_polyline': 'ca}gAk{|tS{AsACQDm@D_@DA@ITq@Pc@LQb@Sp@Kr@R\\PXThAl@`BnA|AfAZXPRb@PhAr@RPT`@NHb@HpAf@jB`@hAZf@PDPDBb@HPCH?b@LfCrAVPdAj@lAt@bAd@|Bb@JLv@XTDJ?XNx@@VFLA^Dh@@x@RZTThALd@~@xEE\\IJF\\JZZJFPF\\l@jCZdBFf@FV?TCNJn@Nl@@RJ`@RLHZRdAPp@@d@ERIFERMVUTO\\g@f@s@nAWn@Gf@DbCF\\Xx@Ll@Pf@B`@M^_BhBSDs@IwAu@iA}@w@i@c@a@a@o@e@]OW[}@My@C[Ho@DMTWr@]\\a@HWFo@Pi@?s@Cs@Bo@DiAJaA@]EWQWYc@YYQ]gAmAa@m@g@eAOaAIYAq@Ga@cBeFS_@e@Wg@QmBi@s@WMAQIWCm@YiA[y@_@]Uc@]UW_@e@y@c@a@OOAc@Hc@V_Br@q@Je@^[FUCWKY]AGWe@Ic@E_@GOo@o@DJ^XPVPhANZ', 'resource_state': 2}, 'trainer': False, 'commute': False, 'manual': False, 'private': False, 'visibility': 'everyone', 'flagged': False, 'gear_id': None, 'start_latlng': [11.949969, 108.450803], 'end_latlng': [11.947736, 108.448426], 'average_speed': 1.854, 'max_speed': 3.28, 'average_cadence': 86.1, 'has_heartrate': True, 'average_heartrate': 156.0, 'max_heartrate': 183.0, 'heartrate_opt_out': False, 'display_hide_heartrate_option': True, 'elev_high': 1483.5, 'elev_low': 1481.1, 'upload_id': 14027719293, 'upload_id_str': '14027719293', 'external_id': 'garmin_ping_395158925863', 'from_accepted_tag': False, 'pr_count': 0, 'total_photo_count': 3, 'has_kudoed': False}, {'resource_state': 2, 'athlete': {'id': 46133187, 'resource_state': 1}, 'name': 'ƒê√† L·∫°t n·∫Øng ƒë·∫πp l·∫°i r·ªìi üçÄüçÄüçÄüòôüòôüòô', 'distance': 4999.5, 'moving_time': 2821, 'elapsed_time': 2991, 'total_elevation_gain': 2.2, 'type': 'Run', 'sport_type': 'Run', 'workout_type': 0, 'id': 13141058537, 'start_date': '2024-12-18T09:56:28Z', 'start_date_local': '2024-12-18T16:56:28Z', 'timezone': '(GMT+07:00) Asia/Ho_Chi_Minh', 'utc_offset': 25200.0, 'location_city': None, 'location_state': None, 'location_country': None, 'achievement_count': 0, 'kudos_count': 3, 'comment_count': 0, 'athlete_count': 1, 'photo_count': 0, 'map': {'id': 'a13141058537', 'summary_polyline': 'ai{gAmg|tSwBe@s@Sq@W}@SkAe@w@g@cBy@QOs@]eAs@WKe@Qw@?UGCGSQQEOAq@S[Cu@SYCmAi@KGw@UIGU_@SSmA}@e@Wc@g@[OgAy@g@U_@SQQKC_@Y_@U_@a@QG_@Mc@Ac@H_@RW^_@tAKb@F\\Xp@TTb@n@h@NPXb@ZF\\HFNVt@tAJHr@zANt@n@t@HXD`@FVb@z@NLd@J\\CXSBKBARE^Ch@SPQXIp@YXIXAr@Tf@Xj@f@x@~@n@ZrBn@bAb@|@RHD`AXt@Zp@TTLDHXn@Nj@bArCPxBJn@Nb@d@v@r@|@f@d@t@pA^`@Nv@CT?f@Ev@ALKNAPBZE\\DZHVA^Oh@Gn@Qf@MNWN[J[TEHIf@An@PbAH\\^j@NPZXJPn@n@hBxAZPf@^XJ`@H\\AVIrAaBJS@WCW_AeDAM?k@AE?{ANe@^}@j@y@lAwAP[La@A_@G_@a@qBEIOCCGc@sBA[FQe@wB', 'resource_state': 2}, 'trainer': False, 'commute': False, 'manual': False, 'private': False, 'visibility': 'everyone', 'flagged': False, 'gear_id': None, 'start_latlng': [11.940506, 108.447898], 'end_latlng': [11.940324, 108.447291], 'average_speed': 1.772, 'max_speed': 2.588, 'average_cadence': 82.5, 'has_heartrate': True, 'average_heartrate': 155.4, 'max_heartrate': 184.0, 'heartrate_opt_out': False, 'display_hide_heartrate_option': True, 'elev_high': 1483.5, 'elev_low': 1481.1, 'upload_id': 14013754116, 'upload_id_str': '14013754116', 'external_id': 'garmin_ping_394643235201', 'from_accepted_tag': False, 'pr_count': 0, 'total_photo_count': 1, 'has_kudoed': False}]


import pandas as pd
from sqlalchemy import create_engine
import logging

engine = create_engine("mysql+pymysql://root:7913qpzm&@localhost:3306/llm_everykmcounts")

#df_data = pd.DataFrame(json_test)
def json_to_df(activity_data):
    df = pd.DataFrame(data = activity_data)
    return df
#Filter just some columns
# df_data = df_data[["id",
#                 "type",
#                 "sport_type",
#                 "start_date_local",
#                 "distance",
#                 "moving_time"]]
#Column mapping for my database
# col_mapping = {
#     'id': 'strava_activity_id',
#     'type': 'activity_type',
#     'sport_type': 'sport_type',
#     'start_date_local': 'start_date_local',
#     'distance': 'distance_meter',
#     'moving_time': 'elapsed_time_second',
# }
# #Rename columns
# df_data.rename(columns = col_mapping, inplace = True)

# ###Update dataframe to mysql
# update_cols = ["strava_activity_id",
#                 "activity_type",
#                "sport_type",
#                "start_date_local",
#                "distance_meter",
#                "elapsed_time_second"]

# with engine.connect() as conn:
#     df_data[update_cols].to_sql('activities', con=conn, if_exists='replace', index=False, method='multi')

# print("DataFrame updated to MySQL successfully!")

def reformat_dataframe(df_data):
    ##Filter just keep some columns
    df_data_filtered = df_data[["id",
            "type",
            "sport_type",
            "start_date_local",
            "distance",
            "moving_time"]]
    #Column mapping for my database
    col_mapping = {
            'id': 'strava_activity_id',
            'type': 'activity_type',
            'sport_type': 'sport_type',
            'start_date_local': 'start_date_local',
            'distance': 'distance_meter',
            'moving_time': 'elapsed_time_second',
}
    #Rename columns
    formated_df = df_data_filtered.rename(columns = col_mapping, inplace = True)

    return df_data_filtered


def update_df_mysql_db(df_data):
    update_cols = ["strava_activity_id",
                "activity_type",
                "sport_type",
                "start_date_local",
                "distance_meter",
                "elapsed_time_second"]
    engine = create_engine("mysql+pymysql://root:7913qpzm&@localhost:3306/llm_everykmcounts") 
    
    try:
        with engine.connect() as conn:
            df_data[update_cols].to_sql('activities', con=conn, if_exists='replace', index=False, method='multi')
            
            # Check number of rows affected
            result = conn.execute("SELECT COUNT(strava_activity_id) FROM activities")
            rows_affected = result.fetchone()[0]
            print(f"Number of rows inserted: {rows_affected}")

            logging.info(f"DataFrame updated to MySQL successfully. Rows inserted: {rows_affected}") 
    except Exception as e:
        logging.error(f"Error updating DataFrame to MySQL: {e}")
        return False 

    return True 

if __name__ == "__main__":

    #Convert json to dataframe
    df_data = json_to_df(json_test)
    print(df_data)
    #Formatted dataframe
    df_data_format = reformat_dataframe(df_data)
    print("###############")
    print(df_data_format)
    #Import to mysql database
    print("###############")
    print(update_df_mysql_db(df_data_format))
